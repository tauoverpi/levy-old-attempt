---
title: A Hierarchical Task Network Planner
header-includes: |
  \newcommand{\hidden}[1]{}
  <style>
    .codeblock-tag {
        text-align: center;
        text-decoration: underline;
    }
  </style>
abstract: |
    We define a hierarchical planner for NPC intelligence with backtracking from failed goals and dynamic re-planning.
...


    lang: zig esc: [[]] file: src/planner.zig
    -----------------------------------------

    const std = @import("std");

For each new action executed, the current action is pushed to a stack containing the reverse path in-case there's
a need for backtracking.

Plans consist of a sequence of actions which, when executed, accomplish the goal presented for the planner to solve.
During execution, the feasibility of a plan can change (e.g running out of ammo in a ranged attack plan) thus forcing
the planner to once again get involved by taking steps back from the current action to see if there are any alternate
plans to execute. In the case where no alternate plans are found, the planner discards the plan and indicates the
failure to the goal selection system which must now pick a new goal to chase.

An example of this can be seen below where the planner first decides that the path `A -> B -> C` is the most
reasonable.  Later, the actor runs out of ammunition for their ranged weapon and must once again search the area
for more. If more could be found, the actor resumes shooting at the player; if there's no more ammunition around,
the actor has to explore other possible plans to reach their goal. Out of available plans `A -> D` may be chosen
if a melee weapon is present nearby; however, if none exists or the weapon breaks the actor has failed to find a
suitable plan thus has to give up on the goal of killing the player.

![](uml/img/planner-backtracking-execution.png)

\hidden{

    lang: uml esc: none file: uml/planner-backtracking-execution.uml
    ----------------------------------------------------------------

    @startuml img/planner-backtracking-execution.png
    ditaa

    +---------------+  if ranged      +-----------+ have ammo     +--------------+
    | find a weapon +---------------->| find ammo +-------------->| shoot player |
    |               | can't find ammo |           | no more ammo  |              |
    | A             |<----------------+ B         |<--------------+ C            |
    +--+---------+--+                 +-----------+               +---+----------+
             ^   |
             |   |   if melee         +------------+
             |   +------------------->| hit player |
             | weapon broken          |            |
             +------------------------| D          |
                                      +-+----------+

    @enduml

}

    lang: zig esc: none tag: #A plan for the planner
    ------------------------------------------------

    pub const Plan = struct {
        /// Sequence of actions to be executed as generated by the planner
        plan: std.ArrayListUnmanaged(Action) = .{},
        /// Index into the current plan
        index: usize = 0,

        pub const Action = struct {};
    };
